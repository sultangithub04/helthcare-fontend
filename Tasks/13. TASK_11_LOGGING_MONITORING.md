# Task 11: Logging & Monitoring with Winston and Sentry

## üìã Task Overview

**Difficulty**: üü° **INTERMEDIATE**  
**Estimated Time**: 3-5 days  
**Priority**: HIGH  
**Category**: DevOps & Monitoring

### Objective

Implement comprehensive logging and error monitoring system using Winston for structured logging and Sentry for error tracking. Create log files for different severity levels, implement request logging middleware, set up error alerting, track performance metrics, and establish monitoring dashboards to quickly identify and resolve production issues.

### Learning Outcomes

- Master Winston logging framework
- Implement structured logging
- Set up log rotation and archival
- Integrate Sentry for error tracking
- Track application performance
- Create custom error contexts
- Set up alerting rules
- Analyze logs for debugging

---

## üéØ Requirements

### Functional Requirements

1. **Log Levels & Destinations**
   | Level | Use Case | Destination | Retention |
   |-------|----------|-------------|-----------|
   | ERROR | Critical failures | File + Sentry | 90 days |
   | WARN | Potential issues | File | 30 days |
   | INFO | Important events | File | 14 days |
   | HTTP | API requests | File | 7 days |
   | DEBUG | Development info | Console | N/A |

2. **What to Log**

   - API requests/responses
   - Authentication attempts
   - Database queries (slow queries)
   - External API calls
   - Errors and exceptions
   - Performance metrics
   - Security events

3. **Monitoring Features**
   - Real-time error tracking
   - Performance monitoring
   - User session tracking
   - Breadcrumbs for debugging
   - Release tracking
   - Custom metrics

### Technical Requirements

1. **Technology Stack**

   - **Logging**: Winston v3
   - **Error Tracking**: Sentry
   - **Log Rotation**: winston-daily-rotate-file
   - **Request Logging**: morgan
   - **Performance**: Sentry Performance Monitoring

2. **Free Tier Limits**

   - Sentry: 5,000 errors/month (free)
   - Log storage: Local disk (no cost)
   - Log retention: Configurable

3. **Performance**
   - Logging overhead <5ms per request
   - Non-blocking log writes
   - Async error reporting
   - Minimal memory footprint

---

## üèóÔ∏è Logging Architecture

### System Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Application Events                         ‚îÇ
‚îÇ  - API Requests                                         ‚îÇ
‚îÇ  - Database Queries                                     ‚îÇ
‚îÇ  - Errors & Exceptions                                  ‚îÇ
‚îÇ  - Performance Metrics                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  Winston Logger  ‚îÇ
        ‚îÇ  (Centralized)   ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                 ‚îÇ
        ‚ñº                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Log Files    ‚îÇ  ‚îÇ   Console    ‚îÇ
‚îÇ  (Rotating)   ‚îÇ  ‚îÇ  (Dev mode)  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ error.log     ‚îÇ
‚îÇ combined.log  ‚îÇ
‚îÇ http.log      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚îÇ (Critical Errors)
        ‚îÇ
        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           Sentry.io                  ‚îÇ
‚îÇ  - Error tracking                   ‚îÇ
‚îÇ  - Performance monitoring           ‚îÇ
‚îÇ  - User context                     ‚îÇ
‚îÇ  - Breadcrumbs                      ‚îÇ
‚îÇ  - Release tracking                 ‚îÇ
‚îÇ  - Alerting                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Notifications  ‚îÇ
‚îÇ  - Email        ‚îÇ
‚îÇ  - Slack        ‚îÇ
‚îÇ  - Discord      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìù Implementation Guide

### Phase 1: Winston Logger Setup

#### Step 1.1: Install Dependencies

```bash
cd backend
pnpm install winston winston-daily-rotate-file morgan
```

#### Step 1.2: Create Logger Configuration

**File**: `backend/src/app/config/logger.ts`

```typescript
import winston from "winston";
import DailyRotateFile from "winston-daily-rotate-file";
import path from "path";

const { combine, timestamp, printf, colorize, errors } = winston.format;

// Custom log format
const logFormat = printf(
  ({ level, message, timestamp, stack, ...metadata }) => {
    let msg = `${timestamp} [${level}]: ${message}`;

    // Add metadata if exists
    if (Object.keys(metadata).length > 0) {
      msg += ` ${JSON.stringify(metadata)}`;
    }

    // Add stack trace for errors
    if (stack) {
      msg += `\n${stack}`;
    }

    return msg;
  }
);

// Create logs directory if it doesn't exist
const logsDir = path.join(process.cwd(), "logs");

// Transport for error logs
const errorTransport = new DailyRotateFile({
  filename: path.join(logsDir, "error-%DATE%.log"),
  datePattern: "YYYY-MM-DD",
  level: "error",
  maxSize: "20m",
  maxFiles: "90d",
  format: combine(
    timestamp({ format: "YYYY-MM-DD HH:mm:ss" }),
    errors({ stack: true }),
    logFormat
  ),
});

// Transport for combined logs
const combinedTransport = new DailyRotateFile({
  filename: path.join(logsDir, "combined-%DATE%.log"),
  datePattern: "YYYY-MM-DD",
  maxSize: "20m",
  maxFiles: "14d",
  format: combine(
    timestamp({ format: "YYYY-MM-DD HH:mm:ss" }),
    errors({ stack: true }),
    logFormat
  ),
});

// Transport for HTTP logs
const httpTransport = new DailyRotateFile({
  filename: path.join(logsDir, "http-%DATE%.log"),
  datePattern: "YYYY-MM-DD",
  level: "http",
  maxSize: "20m",
  maxFiles: "7d",
  format: combine(timestamp({ format: "YYYY-MM-DD HH:mm:ss" }), logFormat),
});

// Console transport (for development)
const consoleTransport = new winston.transports.Console({
  format: combine(
    colorize(),
    timestamp({ format: "YYYY-MM-DD HH:mm:ss" }),
    logFormat
  ),
});

// Create logger instance
const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || "info",
  transports: [errorTransport, combinedTransport, httpTransport],
});

// Add console in development
if (process.env.NODE_ENV !== "production") {
  logger.add(consoleTransport);
}

// Create a stream object for Morgan
export const stream = {
  write: (message: string) => {
    logger.http(message.trim());
  },
};

export default logger;
```

#### Step 1.3: Create Morgan Middleware

**File**: `backend/src/app/middlewares/requestLogger.ts`

```typescript
import morgan from "morgan";
import { stream } from "../config/logger";

// Custom token for user ID
morgan.token("user", (req: any) => {
  return req.user?.userId || "anonymous";
});

// Custom token for response time in ms
morgan.token("response-time-ms", (req, res) => {
  const responseTime = res.getHeader("X-Response-Time");
  return responseTime ? `${responseTime}ms` : "-";
});

// Define morgan format
const morganFormat =
  ':remote-addr - :user [:date[clf]] ":method :url HTTP/:http-version" :status :res[content-length] ":referrer" ":user-agent" - :response-time ms';

// Create middleware
const requestLogger = morgan(morganFormat, { stream });

export default requestLogger;
```

#### Step 1.4: Create Response Time Middleware

**File**: `backend/src/app/middlewares/responseTime.ts`

```typescript
import { Request, Response, NextFunction } from "express";

export const responseTime = (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  const startTime = Date.now();

  res.on("finish", () => {
    const duration = Date.now() - startTime;
    res.setHeader("X-Response-Time", duration);
  });

  next();
};
```

#### Step 1.5: Integrate Logger in App

**File**: `backend/src/app.ts`

```typescript
import express, { Application } from "express";
import requestLogger from "./app/middlewares/requestLogger";
import { responseTime } from "./app/middlewares/responseTime";
import logger from "./app/config/logger";

const app: Application = express();

// Add response time tracking
app.use(responseTime);

// Add request logging
app.use(requestLogger);

// Log application start
logger.info("Application started", {
  environment: process.env.NODE_ENV,
  port: process.env.PORT,
});

// ... rest of your app configuration

export default app;
```

---

### Phase 2: Sentry Integration

#### Step 2.1: Install Sentry

```bash
cd backend
pnpm install @sentry/node @sentry/profiling-node
```

```bash
cd frontend
npm install @sentry/nextjs
```

#### Step 2.2: Configure Backend Sentry

**File**: `backend/src/app/config/sentry.ts`

```typescript
import * as Sentry from "@sentry/node";
import { nodeProfilingIntegration } from "@sentry/profiling-node";
import config from "./index";

export function initSentry() {
  if (!config.sentry.dsn) {
    console.warn("Sentry DSN not configured");
    return;
  }

  Sentry.init({
    dsn: config.sentry.dsn,
    environment: config.env,
    release: `phhealth-backend@${process.env.npm_package_version}`,

    // Performance Monitoring
    tracesSampleRate: config.env === "production" ? 0.1 : 1.0,

    // Profiling
    profilesSampleRate: config.env === "production" ? 0.1 : 1.0,
    integrations: [nodeProfilingIntegration()],

    // Filter sensitive data
    beforeSend(event, hint) {
      // Remove sensitive headers
      if (event.request?.headers) {
        delete event.request.headers.authorization;
        delete event.request.headers.cookie;
      }

      // Remove sensitive data from body
      if (event.request?.data) {
        const data = event.request.data as any;
        if (data.password) delete data.password;
        if (data.token) delete data.token;
      }

      return event;
    },
  });
}

export { Sentry };
```

**File**: `backend/src/server.ts`

```typescript
import { initSentry, Sentry } from "./app/config/sentry";
import app from "./app";
import logger from "./app/config/logger";

// Initialize Sentry first
initSentry();

// Sentry request handler (must be before routes)
app.use(Sentry.Handlers.requestHandler());
app.use(Sentry.Handlers.tracingHandler());

// ... your routes ...

// Sentry error handler (must be before other error middleware)
app.use(Sentry.Handlers.errorHandler());

// Custom error handler
app.use((err: any, req: any, res: any, next: any) => {
  logger.error("Unhandled error:", {
    error: err.message,
    stack: err.stack,
    url: req.url,
    method: req.method,
  });

  res.status(err.status || 500).json({
    success: false,
    message: err.message || "Internal Server Error",
  });
});

const PORT = process.env.PORT || 5000;

const server = app.listen(PORT, () => {
  logger.info(`Server running on port ${PORT}`);
});

// Handle unhandled rejections
process.on("unhandledRejection", (reason: Error) => {
  logger.error("Unhandled Rejection:", {
    error: reason.message,
    stack: reason.stack,
  });
  Sentry.captureException(reason);
  server.close(() => process.exit(1));
});

// Handle uncaught exceptions
process.on("uncaughtException", (error: Error) => {
  logger.error("Uncaught Exception:", {
    error: error.message,
    stack: error.stack,
  });
  Sentry.captureException(error);
  server.close(() => process.exit(1));
});
```

#### Step 2.3: Configure Frontend Sentry

**File**: `frontend/sentry.client.config.ts`

```typescript
import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  environment: process.env.NODE_ENV,

  // Performance Monitoring
  tracesSampleRate: 0.1,

  // Session Replay
  replaysSessionSampleRate: 0.1,
  replaysOnErrorSampleRate: 1.0,

  integrations: [
    Sentry.replayIntegration({
      maskAllText: true,
      blockAllMedia: true,
    }),
  ],

  beforeSend(event, hint) {
    // Filter out specific errors
    if (event.exception) {
      const error = hint.originalException as Error;
      if (error.message.includes("ResizeObserver")) {
        return null; // Don't send to Sentry
      }
    }
    return event;
  },
});
```

**File**: `frontend/sentry.server.config.ts`

```typescript
import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1,
});
```

**File**: `frontend/sentry.edge.config.ts`

```typescript
import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1,
});
```

#### Step 2.4: Update next.config.ts

**File**: `frontend/next.config.ts`

```typescript
import { withSentryConfig } from "@sentry/nextjs";

const nextConfig = {
  // ... your existing config
};

export default withSentryConfig(nextConfig, {
  org: process.env.SENTRY_ORG,
  project: process.env.SENTRY_PROJECT,
  silent: !process.env.CI,
  widenClientFileUpload: true,
  hideSourceMaps: true,
  disableLogger: true,
});
```

---

### Phase 3: Custom Logging Utilities

#### Step 3.1: Create Database Query Logger

**File**: `backend/src/app/middlewares/queryLogger.ts`

```typescript
import { Prisma } from "@prisma/client";
import logger from "../config/logger";

export const queryLogger: Prisma.Middleware = async (params, next) => {
  const before = Date.now();

  const result = await next(params);

  const after = Date.now();
  const duration = after - before;

  // Log slow queries (> 1000ms)
  if (duration > 1000) {
    logger.warn("Slow query detected", {
      model: params.model,
      action: params.action,
      duration: `${duration}ms`,
    });
  }

  // Log all queries in development
  if (process.env.NODE_ENV === "development") {
    logger.debug("Database query", {
      model: params.model,
      action: params.action,
      duration: `${duration}ms`,
    });
  }

  return result;
};
```

Add to Prisma client:

```typescript
import prisma from "./shared/prisma";
import { queryLogger } from "./middlewares/queryLogger";

prisma.$use(queryLogger);
```

#### Step 3.2: Create Security Event Logger

**File**: `backend/src/app/utils/securityLogger.ts`

```typescript
import logger from "../config/logger";
import { Sentry } from "../config/sentry";

export const logSecurityEvent = (
  event: string,
  details: {
    userId?: string;
    ip?: string;
    userAgent?: string;
    severity?: "low" | "medium" | "high" | "critical";
    [key: string]: any;
  }
) => {
  const { severity = "medium", ...rest } = details;

  logger.warn(`Security Event: ${event}`, rest);

  // Send critical events to Sentry
  if (severity === "critical" || severity === "high") {
    Sentry.captureMessage(`Security Event: ${event}`, {
      level: severity === "critical" ? "error" : "warning",
      extra: rest,
    });
  }
};

// Usage examples:
// logSecurityEvent('Failed login attempt', { userId: 'user-123', ip: '1.2.3.4', severity: 'medium' });
// logSecurityEvent('Unauthorized access attempt', { path: '/admin', severity: 'high' });
```

---

## ‚úÖ Testing Checklist

### Winston Logging

- [ ] Logs written to files
- [ ] Log rotation working
- [ ] Different log levels separated
- [ ] Console logs in development
- [ ] HTTP requests logged
- [ ] Error stack traces captured

### Sentry

- [ ] Errors sent to Sentry
- [ ] Performance monitoring working
- [ ] User context attached
- [ ] Breadcrumbs recorded
- [ ] Release tracking configured
- [ ] Sensitive data filtered

### Monitoring

- [ ] Slow queries detected
- [ ] Security events logged
- [ ] API errors tracked
- [ ] Performance metrics collected

---

## üéØ Acceptance Criteria

1. ‚úÖ Winston logger configured
2. ‚úÖ Log rotation implemented
3. ‚úÖ HTTP requests logged
4. ‚úÖ Sentry integrated (backend + frontend)
5. ‚úÖ Error tracking working
6. ‚úÖ Performance monitoring enabled
7. ‚úÖ Security events logged
8. ‚úÖ Slow queries detected
9. ‚úÖ Sensitive data filtered
10. ‚úÖ Alerts configured

---

## üìñ Resources

- [Winston Documentation](https://github.com/winstonjs/winston)
- [Sentry Node.js](https://docs.sentry.io/platforms/node/)
- [Sentry Next.js](https://docs.sentry.io/platforms/javascript/guides/nextjs/)
- [Morgan Documentation](https://github.com/expressjs/morgan)

---

**Task Status**: üìù Ready for implementation  
**Estimated Completion**: 3-5 days  
**Impact**: Better debugging, error tracking, performance insights

---

_You can't fix what you can't see. Log everything!_ üìä
