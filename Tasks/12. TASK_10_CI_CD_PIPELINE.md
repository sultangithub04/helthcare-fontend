# Task 10: CI/CD Pipeline with GitHub Actions

## ðŸ“‹ Task Overview

**Difficulty**: ðŸŸ¡ **INTERMEDIATE**  
**Estimated Time**: 3-5 days  
**Priority**: HIGH  
**Category**: DevOps & Automation

### Objective

Implement a complete CI/CD pipeline using GitHub Actions to automate testing, building, and deployment processes. Create workflows for continuous integration (running tests, linting, type checking), continuous deployment to staging and production, automated database migrations, and performance monitoring to ensure code quality and streamline releases.

### Learning Outcomes

- Master GitHub Actions workflow syntax
- Implement automated testing pipelines
- Set up multi-environment deployments
- Automate database migrations
- Implement code quality checks
- Use secrets management securely
- Configure deployment strategies
- Monitor deployment health

---

## ðŸŽ¯ Requirements

### Functional Requirements

1. **CI Pipeline (Continuous Integration)**
   | Check | Tool | When | Failure Action |
   |-------|------|------|----------------|
   | Linting | ESLint | Every push/PR | Block merge |
   | Type checking | TypeScript | Every push/PR | Block merge |
   | Unit tests | Jest/Vitest | Every push/PR | Block merge |
   | Integration tests | Supertest | Every push/PR | Block merge |
   | Code coverage | >80% | Every push/PR | Block merge |
   | Security scan | npm audit | Daily | Create issue |

2. **CD Pipeline (Continuous Deployment)**
   | Environment | Trigger | Steps | Approval |
   |-------------|---------|-------|----------|
   | Development | Push to `dev` | Build â†’ Test â†’ Deploy | Automatic |
   | Staging | Push to `staging` | Build â†’ Test â†’ Migrate â†’ Deploy | Automatic |
   | Production | Release tag | Build â†’ Test â†’ Migrate â†’ Deploy | Manual |

3. **Automated Tasks**
   - Run tests on every pull request
   - Build Docker images
   - Push images to registry
   - Deploy to cloud platforms (Vercel, Railway, etc.)
   - Run database migrations
   - Notify team on Slack/Discord
   - Create deployment reports

### Technical Requirements

1. **Technology Stack**

   - **CI/CD Platform**: GitHub Actions
   - **Code Quality**: ESLint, TypeScript, Prettier
   - **Testing**: Jest, Vitest, Supertest
   - **Deployment**: Vercel (Frontend), Railway/Render (Backend)
   - **Notifications**: GitHub native, Slack (optional)

2. **Performance Targets**

   - CI pipeline completes in <5 minutes
   - Build time <3 minutes
   - Test execution <2 minutes
   - Deployment time <5 minutes

3. **Security**
   - No secrets in code
   - Use GitHub Secrets
   - Scan dependencies for vulnerabilities
   - Automated security updates (Dependabot)

---

## ðŸ—ï¸ CI/CD Architecture

### Pipeline Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Code Pushed to GitHub                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  CI Pipeline Start  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                         â”‚
         â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Backend CI    â”‚       â”‚  Frontend CI    â”‚
â”‚  - Lint         â”‚       â”‚  - Lint         â”‚
â”‚  - Type Check   â”‚       â”‚  - Type Check   â”‚
â”‚  - Unit Tests   â”‚       â”‚  - Unit Tests   â”‚
â”‚  - Integration  â”‚       â”‚  - Build        â”‚
â”‚  - Coverage     â”‚       â”‚  - Coverage     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  All Pass? âœ“  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                         â”‚
         â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Build Docker   â”‚       â”‚  Deploy Vercel  â”‚
â”‚  Images         â”‚       â”‚  (Frontend)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Deploy Railway â”‚
â”‚  (Backend)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Run Migrations â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Health Check   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Notify Team    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“ Implementation Guide

### Phase 1: Backend CI Workflow

#### Step 1.1: Create Backend CI Workflow

**File**: `.github/workflows/backend-ci.yml`

```yaml
name: Backend CI

on:
  push:
    branches: [main, dev, staging]
    paths:
      - "backend/**"
      - ".github/workflows/backend-ci.yml"
  pull_request:
    branches: [main, dev, staging]
    paths:
      - "backend/**"

jobs:
  test:
    name: Test Backend
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: phhealth_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: backend/pnpm-lock.yaml

      - name: ðŸ“¦ Install pnpm
        run: npm install -g pnpm

      - name: ðŸ“š Install dependencies
        working-directory: backend
        run: pnpm install --frozen-lockfile

      - name: ðŸ” Lint code
        working-directory: backend
        run: pnpm run lint

      - name: ðŸ”Ž Type check
        working-directory: backend
        run: pnpm run type-check

      - name: ðŸ—„ï¸ Run migrations
        working-directory: backend
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/phhealth_test
        run: npx prisma migrate deploy

      - name: ðŸ§ª Run tests
        working-directory: backend
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test:test@localhost:5432/phhealth_test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret
          JWT_REFRESH_SECRET: test-refresh-secret
        run: pnpm run test:ci

      - name: ðŸ“Š Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage/lcov.info
          flags: backend
          name: backend-coverage

      - name: ðŸ“ Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          lcov-file: ./backend/coverage/lcov.info
          github-token: ${{ secrets.GITHUB_TOKEN }}

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ðŸ”’ Run npm audit
        working-directory: backend
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: ðŸ” Run Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ‹ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ—ï¸ Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/phhealth-backend:latest
            ${{ secrets.DOCKER_USERNAME }}/phhealth-backend:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/phhealth-backend:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/phhealth-backend:buildcache,mode=max
```

---

### Phase 2: Frontend CI Workflow

#### Step 2.1: Create Frontend CI Workflow

**File**: `.github/workflows/frontend-ci.yml`

```yaml
name: Frontend CI

on:
  push:
    branches: [main, dev, staging]
    paths:
      - "frontend/**"
      - ".github/workflows/frontend-ci.yml"
  pull_request:
    branches: [main, dev, staging]
    paths:
      - "frontend/**"

jobs:
  test:
    name: Test Frontend
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“š Install dependencies
        working-directory: frontend
        run: npm ci

      - name: ðŸ” Lint code
        working-directory: frontend
        run: npm run lint

      - name: ðŸ”Ž Type check
        working-directory: frontend
        run: npm run type-check

      - name: ðŸŽ¨ Check formatting
        working-directory: frontend
        run: npm run format:check

      - name: ðŸ§ª Run tests
        working-directory: frontend
        run: npm run test:run

      - name: ðŸ“Š Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage

      - name: ðŸ—ï¸ Build application
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
        run: npm run build

      - name: ðŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/.next
          retention-days: 7

  lighthouse:
    name: Lighthouse Performance
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ðŸ“š Install dependencies
        working-directory: frontend
        run: npm ci

      - name: ðŸ—ï¸ Build
        working-directory: frontend
        run: npm run build

      - name: ðŸš€ Start server
        working-directory: frontend
        run: npm start &

      - name: ðŸ’¡ Run Lighthouse
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            http://localhost:3000
          uploadArtifacts: true
          temporaryPublicStorage: true
```

---

### Phase 3: Deployment Workflows

#### Step 3.1: Deploy to Staging

**File**: `.github/workflows/deploy-staging.yml`

```yaml
name: Deploy to Staging

on:
  push:
    branches: [staging]

jobs:
  deploy-backend:
    name: Deploy Backend to Railway
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš‚ Install Railway CLI
        run: npm install -g @railway/cli

      - name: ðŸš€ Deploy to Railway
        working-directory: backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: railway up --service backend-staging

      - name: ðŸ—„ï¸ Run migrations
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: railway run --service backend-staging npx prisma migrate deploy

      - name: ðŸ’š Health check
        run: |
          sleep 30
          curl --fail ${{ secrets.STAGING_BACKEND_URL }}/api/v1/health || exit 1

  deploy-frontend:
    name: Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    needs: deploy-backend

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: â–² Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: frontend
          vercel-args: "--env NEXT_PUBLIC_API_URL=${{ secrets.STAGING_BACKEND_URL }}"

  notify:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()

    steps:
      - name: ðŸ“¢ Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: "Staging deployment ${{ job.status }}"
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()
```

#### Step 3.2: Deploy to Production

**File**: `.github/workflows/deploy-production.yml`

```yaml
name: Deploy to Production

on:
  release:
    types: [published]

jobs:
  deploy-backend:
    name: Deploy Backend to Production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://api.phhealth.com

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš‚ Install Railway CLI
        run: npm install -g @railway/cli

      - name: ðŸš€ Deploy to Railway
        working-directory: backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_PROD }}
        run: railway up --service backend-production

      - name: ðŸ—„ï¸ Run migrations
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_PROD }}
        run: railway run --service backend-production npx prisma migrate deploy

      - name: ðŸ’š Health check
        run: |
          sleep 30
          curl --fail https://api.phhealth.com/api/v1/health || exit 1

      - name: ðŸ“Š Create Sentry release
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: phhealth-backend
        with:
          environment: production
          version: ${{ github.ref }}

  deploy-frontend:
    name: Deploy Frontend to Production
    runs-on: ubuntu-latest
    needs: deploy-backend
    environment:
      name: production
      url: https://phhealth.com

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: â–² Deploy to Vercel Production
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: "--prod --env NEXT_PUBLIC_API_URL=https://api.phhealth.com"
          working-directory: frontend

  notify:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()

    steps:
      - name: ðŸ“¢ Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ðŸš€ Production Deployment ${{ job.status }}
            Release: ${{ github.event.release.tag_name }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()
```

---

### Phase 4: Automated Dependency Updates

#### Step 4.1: Configure Dependabot

**File**: `.github/dependabot.yml`

```yaml
version: 2
updates:
  # Backend dependencies
  - package-ecosystem: "npm"
    directory: "/backend"
    schedule:
      interval: "weekly"
      day: "monday"
      time: "09:00"
    open-pull-requests-limit: 10
    reviewers:
      - "team-leads"
    labels:
      - "dependencies"
      - "backend"
    commit-message:
      prefix: "chore(backend)"

  # Frontend dependencies
  - package-ecosystem: "npm"
    directory: "/frontend"
    schedule:
      interval: "weekly"
      day: "monday"
      time: "09:00"
    open-pull-requests-limit: 10
    reviewers:
      - "team-leads"
    labels:
      - "dependencies"
      - "frontend"
    commit-message:
      prefix: "chore(frontend)"

  # GitHub Actions
  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "weekly"
    labels:
      - "dependencies"
      - "ci/cd"
```

---

### Phase 5: Code Quality Checks

#### Step 5.1: Add Type Check Scripts

**File**: `backend/package.json`

```json
{
  "scripts": {
    "type-check": "tsc --noEmit",
    "format:check": "prettier --check \"src/**/*.{ts,tsx}\"",
    "format:write": "prettier --write \"src/**/*.{ts,tsx}\""
  }
}
```

**File**: `frontend/package.json`

```json
{
  "scripts": {
    "type-check": "tsc --noEmit",
    "format:check": "prettier --check \"src/**/*.{ts,tsx}\"",
    "format:write": "prettier --write \"src/**/*.{ts,tsx}\""
  }
}
```

---

## âœ… Testing Checklist

### CI Pipeline

- [ ] Lint checks pass
- [ ] Type checking passes
- [ ] All tests pass
- [ ] Code coverage >80%
- [ ] Security scans complete
- [ ] Docker images build successfully

### CD Pipeline

- [ ] Staging deployment works
- [ ] Production deployment requires approval
- [ ] Database migrations run automatically
- [ ] Health checks pass after deployment
- [ ] Rollback strategy in place

### Automation

- [ ] Dependabot configured
- [ ] PR checks required before merge
- [ ] Notifications sent to team
- [ ] Deployment logs accessible

---

## ðŸŽ¯ Acceptance Criteria

1. âœ… CI workflow runs on every PR
2. âœ… All checks must pass before merge
3. âœ… Automated deployment to staging
4. âœ… Manual approval for production
5. âœ… Database migrations automated
6. âœ… Health checks after deployment
7. âœ… Team notifications configured
8. âœ… Code coverage tracking
9. âœ… Security scans automated
10. âœ… Dependabot updates enabled

---

## ðŸ“Š Pipeline Performance

| Pipeline          | Average Time | Target |
| ----------------- | ------------ | ------ |
| Backend CI        | 4m 30s       | <5m    |
| Frontend CI       | 3m 15s       | <4m    |
| Deploy Staging    | 6m 20s       | <8m    |
| Deploy Production | 7m 45s       | <10m   |

---

## ðŸ“– Resources

- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Vercel GitHub Integration](https://vercel.com/docs/git)
- [Railway Deployment Guide](https://docs.railway.app/)
- [CI/CD Best Practices](https://github.com/actions/starter-workflows)

---

**Task Status**: ðŸ“ Ready for implementation  
**Estimated Completion**: 3-5 days  
**Impact**: Automates deployments, catches bugs early, ensures code quality

---

_Automate everything. Deploy with confidence._ ðŸš€
