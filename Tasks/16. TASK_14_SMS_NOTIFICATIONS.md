# Task 14: SMS Notifications with Twilio

## üìã Task Overview

**Difficulty**: üü¢ **BEGINNER-INTERMEDIATE**  
**Estimated Time**: 2-3 days  
**Priority**: MEDIUM  
**Category**: Communication & Notifications

### Objective

Implement SMS notification system using Twilio's free trial to send appointment reminders, OTP verification codes, and urgent alerts to patients and doctors. Enable two-factor authentication via SMS, automated appointment reminders, and emergency notifications to improve communication and reduce no-shows.

### Learning Outcomes

- Master Twilio SMS API
- Implement OTP verification
- Send scheduled SMS reminders
- Handle SMS delivery status
- Manage Twilio webhooks
- Implement rate limiting for SMS
- Track SMS costs and usage
- Handle international phone numbers

---

## üéØ Requirements

### Functional Requirements

1. **SMS Types**
   | Type | Use Case | When Sent | Priority |
   |------|----------|-----------|----------|
   | OTP Verification | Login, MFA | Immediate | HIGH |
   | Appointment Reminder | 24h & 1h before | Scheduled | HIGH |
   | Appointment Confirmation | After booking | Immediate | MEDIUM |
   | Payment Reminder | Payment pending | Scheduled | MEDIUM |
   | Prescription Ready | Doctor uploads | Immediate | MEDIUM |
   | Cancellation Alert | Appointment cancelled | Immediate | HIGH |

2. **SMS Features**

   - Personalized messages
   - Short URLs for links
   - Delivery status tracking
   - Retry mechanism for failures
   - Opt-out handling
   - International support

3. **User Preferences**
   - Enable/disable SMS per type
   - Preferred time windows
   - Language preference
   - Opt-out management

### Technical Requirements

1. **Technology Stack**

   - **SMS Provider**: Twilio (Free trial: $15 credit)
   - **Backend**: twilio npm package
   - **Scheduling**: node-cron or Bull queue
   - **Database**: Store SMS logs

2. **Free Tier Limits**

   - Twilio Trial: $15 credit (~500 SMS in US)
   - Test numbers unlimited (verified numbers only)
   - After trial: Pay-as-you-go (~$0.0075/SMS in US)

3. **Performance**
   - SMS delivery < 10 seconds
   - OTP generation in < 1 second
   - Queue processing for bulk SMS
   - Retry failed messages up to 3 times

---

## üèóÔ∏è SMS Architecture

### System Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Application Events                         ‚îÇ
‚îÇ  - User registration                                    ‚îÇ
‚îÇ  - Login attempt                                        ‚îÇ
‚îÇ  - Appointment booked                                   ‚îÇ
‚îÇ  - Payment pending                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  SMS Service     ‚îÇ
        ‚îÇ  (Backend)       ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                 ‚îÇ
        ‚ñº                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Immediate    ‚îÇ  ‚îÇ  Scheduled   ‚îÇ
‚îÇ  SMS Queue    ‚îÇ  ‚îÇ  SMS Queue   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ - OTP codes   ‚îÇ  ‚îÇ - Reminders  ‚îÇ
‚îÇ - Alerts      ‚îÇ  ‚îÇ - Follow-ups ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                 ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  Twilio API     ‚îÇ
        ‚îÇ  (SMS Gateway)  ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  User's Phone   ‚îÇ
        ‚îÇ  üì±             ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚îÇ (Status Webhook)
                 ‚îÇ
                 ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  SMS Status     ‚îÇ
        ‚îÇ  Handler        ‚îÇ
        ‚îÇ  (Webhook)      ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  Database       ‚îÇ
        ‚îÇ  - SMS logs     ‚îÇ
        ‚îÇ  - Delivery     ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìù Implementation Guide

### Phase 1: Twilio Setup

#### Step 1.1: Create Twilio Account

1. Go to [Twilio Console](https://www.twilio.com/try-twilio)
2. Sign up for free trial ($15 credit)
3. Get your credentials:
   - Account SID
   - Auth Token
   - Twilio Phone Number

#### Step 1.2: Install Twilio SDK

```bash
cd backend
pnpm install twilio
```

#### Step 1.3: Configure Environment

**File**: `backend/.env`

```env
# Twilio Configuration
TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_AUTH_TOKEN=your_auth_token
TWILIO_PHONE_NUMBER=+1234567890
TWILIO_VERIFY_SERVICE_SID=VAxxxxxxxxxxxxxxxxxxxxxxxxx (optional for Verify API)
```

---

### Phase 2: Database Schema

#### Step 2.1: Create SMS Models

**File**: `backend/prisma/schema.prisma`

```prisma
model SMSLog {
  id           String        @id @default(uuid())
  userId       String?
  phoneNumber  String
  message      String
  type         SMSType
  status       SMSStatus     @default(PENDING)
  twilioSid    String?       @unique
  errorMessage String?
  sentAt       DateTime?
  deliveredAt  DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([type])
  @@map("sms_logs")
}

model OTPVerification {
  id          String   @id @default(uuid())
  userId      String?
  phoneNumber String
  code        String
  purpose     String   // 'LOGIN', 'MFA', 'PHONE_VERIFY'
  expiresAt   DateTime
  verified    Boolean  @default(false)
  attempts    Int      @default(0)
  createdAt   DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([phoneNumber])
  @@index([code])
  @@map("otp_verifications")
}

model SMSPreference {
  id                      String   @id @default(uuid())
  userId                  String   @unique
  appointmentReminders    Boolean  @default(true)
  appointmentConfirmation Boolean  @default(true)
  paymentReminders        Boolean  @default(true)
  prescriptionAlerts      Boolean  @default(true)
  optedOut                Boolean  @default(false)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@map("sms_preferences")
}

enum SMSType {
  OTP
  APPOINTMENT_REMINDER
  APPOINTMENT_CONFIRMATION
  PAYMENT_REMINDER
  PRESCRIPTION_ALERT
  CANCELLATION
}

enum SMSStatus {
  PENDING
  QUEUED
  SENT
  DELIVERED
  FAILED
  UNDELIVERED
}
```

Run migration:

```bash
npx prisma migrate dev --name add_sms_tables
```

---

### Phase 3: SMS Service Implementation

#### Step 3.1: Create Twilio Client

**File**: `backend/src/app/config/twilio.ts`

```typescript
import twilio from "twilio";
import config from "./index";

const twilioClient = twilio(config.twilio.accountSid, config.twilio.authToken);

export default twilioClient;
```

**File**: `backend/src/app/config/index.ts` (add Twilio config)

```typescript
export default {
  // ... existing config
  twilio: {
    accountSid: process.env.TWILIO_ACCOUNT_SID,
    authToken: process.env.TWILIO_AUTH_TOKEN,
    phoneNumber: process.env.TWILIO_PHONE_NUMBER,
    verifyServiceSid: process.env.TWILIO_VERIFY_SERVICE_SID,
  },
};
```

#### Step 3.2: Create SMS Service

**File**: `backend/src/app/modules/SMS/sms.service.ts`

```typescript
import twilioClient from "../../config/twilio";
import config from "../../config";
import prisma from "../../shared/prisma";
import { SMSType, SMSStatus } from "@prisma/client";

interface SendSMSParams {
  phoneNumber: string;
  message: string;
  userId?: string;
  type: SMSType;
}

/**
 * Send SMS via Twilio
 */
const sendSMS = async ({
  phoneNumber,
  message,
  userId,
  type,
}: SendSMSParams) => {
  try {
    // Check if user has opted out
    if (userId) {
      const preference = await prisma.sMSPreference.findUnique({
        where: { userId },
      });

      if (preference?.optedOut) {
        console.log(`User ${userId} has opted out of SMS`);
        return null;
      }
    }

    // Send SMS via Twilio
    const twilioMessage = await twilioClient.messages.create({
      body: message,
      from: config.twilio.phoneNumber,
      to: phoneNumber,
      statusCallback: `${config.app.backendUrl}/api/v1/sms/status-callback`,
    });

    // Log SMS
    const smsLog = await prisma.sMSLog.create({
      data: {
        userId,
        phoneNumber,
        message,
        type,
        status: SMSStatus.SENT,
        twilioSid: twilioMessage.sid,
        sentAt: new Date(),
      },
    });

    return smsLog;
  } catch (error: any) {
    console.error("Failed to send SMS:", error);

    // Log failed SMS
    await prisma.sMSLog.create({
      data: {
        userId,
        phoneNumber,
        message,
        type,
        status: SMSStatus.FAILED,
        errorMessage: error.message,
      },
    });

    throw error;
  }
};

/**
 * Generate and send OTP
 */
const sendOTP = async (
  phoneNumber: string,
  userId?: string,
  purpose: string = "LOGIN"
) => {
  // Generate 6-digit OTP
  const code = Math.floor(100000 + Math.random() * 900000).toString();

  // Set expiry (5 minutes)
  const expiresAt = new Date(Date.now() + 5 * 60 * 1000);

  // Save OTP
  await prisma.oTPVerification.create({
    data: {
      userId,
      phoneNumber,
      code,
      purpose,
      expiresAt,
    },
  });

  // Send SMS
  const message = `Your PH-HealthCare verification code is: ${code}. Valid for 5 minutes. Do not share this code.`;

  await sendSMS({
    phoneNumber,
    message,
    userId,
    type: SMSType.OTP,
  });

  return { success: true, expiresAt };
};

/**
 * Verify OTP
 */
const verifyOTP = async (
  phoneNumber: string,
  code: string,
  purpose: string = "LOGIN"
) => {
  const otp = await prisma.oTPVerification.findFirst({
    where: {
      phoneNumber,
      code,
      purpose,
      verified: false,
      expiresAt: {
        gt: new Date(),
      },
    },
    orderBy: {
      createdAt: "desc",
    },
  });

  if (!otp) {
    // Increment attempts
    await prisma.oTPVerification.updateMany({
      where: {
        phoneNumber,
        purpose,
        verified: false,
      },
      data: {
        attempts: {
          increment: 1,
        },
      },
    });

    throw new Error("Invalid or expired OTP");
  }

  // Check attempts limit (max 3)
  if (otp.attempts >= 3) {
    throw new Error("Too many attempts. Please request a new OTP.");
  }

  // Mark as verified
  await prisma.oTPVerification.update({
    where: { id: otp.id },
    data: { verified: true },
  });

  return { success: true, userId: otp.userId };
};

/**
 * Send appointment reminder
 */
const sendAppointmentReminder = async (
  userId: string,
  phoneNumber: string,
  doctorName: string,
  appointmentDate: Date,
  timeInHours: number
) => {
  const timeText =
    timeInHours === 24
      ? "tomorrow"
      : `in ${timeInHours} hour${timeInHours > 1 ? "s" : ""}`;

  const message = `Reminder: You have an appointment with Dr. ${doctorName} ${timeText} at ${appointmentDate.toLocaleTimeString()}. Reply CANCEL to cancel.`;

  await sendSMS({
    phoneNumber,
    message,
    userId,
    type: SMSType.APPOINTMENT_REMINDER,
  });
};

/**
 * Send appointment confirmation
 */
const sendAppointmentConfirmation = async (
  userId: string,
  phoneNumber: string,
  doctorName: string,
  appointmentDate: Date
) => {
  const message = `Your appointment with Dr. ${doctorName} has been confirmed for ${appointmentDate.toLocaleDateString()} at ${appointmentDate.toLocaleTimeString()}. Thank you for choosing PH-HealthCare!`;

  await sendSMS({
    phoneNumber,
    message,
    userId,
    type: SMSType.APPOINTMENT_CONFIRMATION,
  });
};

/**
 * Update SMS preferences
 */
const updatePreferences = async (userId: string, preferences: any) => {
  return await prisma.sMSPreference.upsert({
    where: { userId },
    create: {
      userId,
      ...preferences,
    },
    update: preferences,
  });
};

/**
 * Handle SMS status callback from Twilio
 */
const handleStatusCallback = async (
  twilioSid: string,
  status: string,
  errorMessage?: string
) => {
  const smsStatus = status.toUpperCase() as SMSStatus;

  await prisma.sMSLog.update({
    where: { twilioSid },
    data: {
      status: smsStatus,
      errorMessage,
      deliveredAt: smsStatus === SMSStatus.DELIVERED ? new Date() : undefined,
    },
  });
};

export const SMSService = {
  sendSMS,
  sendOTP,
  verifyOTP,
  sendAppointmentReminder,
  sendAppointmentConfirmation,
  updatePreferences,
  handleStatusCallback,
};
```

---

### Phase 4: Controllers & Routes

#### Step 4.1: Create SMS Controller

**File**: `backend/src/app/modules/SMS/sms.controller.ts`

```typescript
import { Request, Response } from "express";
import catchAsync from "../../shared/catchAsync";
import sendResponse from "../../shared/sendResponse";
import { SMSService } from "./sms.service";

const sendOTP = catchAsync(async (req: Request, res: Response) => {
  const { phoneNumber, purpose } = req.body;

  const result = await SMSService.sendOTP(
    phoneNumber,
    req.user?.userId,
    purpose
  );

  sendResponse(res, {
    statusCode: 200,
    success: true,
    message: "OTP sent successfully",
    data: result,
  });
});

const verifyOTP = catchAsync(async (req: Request, res: Response) => {
  const { phoneNumber, code, purpose } = req.body;

  const result = await SMSService.verifyOTP(phoneNumber, code, purpose);

  sendResponse(res, {
    statusCode: 200,
    success: true,
    message: "OTP verified successfully",
    data: result,
  });
});

const statusCallback = catchAsync(async (req: Request, res: Response) => {
  const { MessageSid, MessageStatus, ErrorMessage } = req.body;

  await SMSService.handleStatusCallback(
    MessageSid,
    MessageStatus,
    ErrorMessage
  );

  res.status(200).send("OK");
});

const updatePreferences = catchAsync(async (req: Request, res: Response) => {
  const userId = req.user.userId;

  const result = await SMSService.updatePreferences(userId, req.body);

  sendResponse(res, {
    statusCode: 200,
    success: true,
    message: "SMS preferences updated",
    data: result,
  });
});

export const SMSController = {
  sendOTP,
  verifyOTP,
  statusCallback,
  updatePreferences,
};
```

#### Step 4.2: Create Routes

**File**: `backend/src/app/modules/SMS/sms.routes.ts`

```typescript
import express from "express";
import { SMSController } from "./sms.controller";
import auth from "../../middlewares/auth";
import { UserRole } from "@prisma/client";

const router = express.Router();

// Public routes
router.post("/send-otp", SMSController.sendOTP);
router.post("/verify-otp", SMSController.verifyOTP);
router.post("/status-callback", SMSController.statusCallback);

// Protected routes
router.patch(
  "/preferences",
  auth(UserRole.PATIENT, UserRole.DOCTOR),
  SMSController.updatePreferences
);

export const SMSRoutes = router;
```

---

### Phase 5: Scheduled Reminders

#### Step 5.1: Create Reminder Scheduler

**File**: `backend/src/app/jobs/appointmentReminders.ts`

```typescript
import cron from "node-cron";
import prisma from "../shared/prisma";
import { SMSService } from "../modules/SMS/sms.service";

/**
 * Send 24-hour appointment reminders
 * Runs every hour
 */
export const schedule24HourReminders = () => {
  cron.schedule("0 * * * *", async () => {
    console.log("Running 24-hour reminder job...");

    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);

    const appointments = await prisma.appointment.findMany({
      where: {
        schedule: {
          startDateTime: {
            gte: tomorrow,
            lt: new Date(tomorrow.getTime() + 60 * 60 * 1000), // Next hour window
          },
        },
        status: "SCHEDULED",
      },
      include: {
        patient: true,
        doctor: true,
        schedule: true,
      },
    });

    for (const appointment of appointments) {
      if (appointment.patient.contactNumber) {
        await SMSService.sendAppointmentReminder(
          appointment.patient.id,
          appointment.patient.contactNumber,
          appointment.doctor.name,
          new Date(appointment.schedule.startDateTime),
          24
        );
      }
    }

    console.log(`Sent ${appointments.length} 24-hour reminders`);
  });
};

/**
 * Send 1-hour appointment reminders
 * Runs every 15 minutes
 */
export const schedule1HourReminders = () => {
  cron.schedule("*/15 * * * *", async () => {
    console.log("Running 1-hour reminder job...");

    const oneHourFromNow = new Date(Date.now() + 60 * 60 * 1000);

    const appointments = await prisma.appointment.findMany({
      where: {
        schedule: {
          startDateTime: {
            gte: new Date(),
            lt: oneHourFromNow,
          },
        },
        status: "SCHEDULED",
      },
      include: {
        patient: true,
        doctor: true,
        schedule: true,
      },
    });

    for (const appointment of appointments) {
      if (appointment.patient.contactNumber) {
        await SMSService.sendAppointmentReminder(
          appointment.patient.id,
          appointment.patient.contactNumber,
          appointment.doctor.name,
          new Date(appointment.schedule.startDateTime),
          1
        );
      }
    }

    console.log(`Sent ${appointments.length} 1-hour reminders`);
  });
};
```

Start schedulers in `server.ts`:

```typescript
import {
  schedule24HourReminders,
  schedule1HourReminders,
} from "./app/jobs/appointmentReminders";

// Start cron jobs
schedule24HourReminders();
schedule1HourReminders();
```

---

## ‚úÖ Testing Checklist

### SMS Sending

- [ ] OTP SMS sent successfully
- [ ] Appointment reminder sent
- [ ] Confirmation SMS sent
- [ ] International numbers work
- [ ] Status callbacks received

### OTP Verification

- [ ] OTP validates correctly
- [ ] Expired OTPs rejected
- [ ] Invalid OTPs rejected
- [ ] Attempt limit enforced
- [ ] OTP marked as used after verification

### Preferences

- [ ] User can opt-out
- [ ] Opted-out users don't receive SMS
- [ ] Preferences saved correctly
- [ ] Different SMS types can be toggled

---

## üéØ Acceptance Criteria

1. ‚úÖ Twilio integration working
2. ‚úÖ OTP generation and verification
3. ‚úÖ Appointment reminders scheduled
4. ‚úÖ SMS status tracking implemented
5. ‚úÖ User preferences system
6. ‚úÖ Opt-out mechanism
7. ‚úÖ Error handling and retries
8. ‚úÖ SMS logs stored
9. ‚úÖ Webhooks configured
10. ‚úÖ International numbers supported

---

## üìñ Resources

- [Twilio SMS API](https://www.twilio.com/docs/sms)
- [Twilio Node.js SDK](https://www.twilio.com/docs/libraries/node)
- [Twilio Verify API](https://www.twilio.com/docs/verify/api)
- [SMS Best Practices](https://www.twilio.com/docs/sms/tutorials/send-sms-best-practices)

---

**Task Status**: üìù Ready for implementation  
**Estimated Completion**: 2-3 days  
**Impact**: Reduces no-shows, improves security, better user communication

---

_Keep patients informed with timely SMS!_ üì±
